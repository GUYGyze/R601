<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire Client WireGuard</title>
    <link rel="stylesheet" href="../../static/styles_client.css">
</head>
<body>
    <h1>Gestionnaire Client WireGuard</h1>

    <div class="card">
        <h2>Configuration du Tunnel WireGuard</h2>
        
        <div class="tabs">
            <div class="tab active" onclick="showTab('client-config')">Configuration Client</div>
            <div class="tab" onclick="showTab('server-config')">Configuration Serveur</div>
        </div>
        
        <div class="tab-content">
            <div class="tab-pane active" id="client-config">
                <h3>Configuration du Client</h3>
                <div class="form-group">
                    <label for="client_name">Nom du client</label>
                    <input type="text" id="client_name" placeholder="Nom du client">
                </div>
                <div class="form-group">
                    <label for="client_ip">Adresse IP du client (Wireguard)</label>
                    <input type="text" id="client_ip" placeholder="10.0.0.2">
                </div>
		<div class="form-group">
                    <label for="client_endpoint">Adresse IP du client (Physique)</label>
                    <input type="text" id="client_endpoint" placeholder="192.168.1.1">
                </div>
                <div class="form-group">
                    <label for="client_listen_port">Port d'écoute du Client</label>
                    <input type="number" id="client_listen_port" placeholder="51820" min="1" max="65535">
                </div>
                <div class="form-group">
                    <button onclick="generateClientKeys()">Générer des clés</button>
                </div>
                <div class="form-group">
                    <label>Clé publique du client:</label>
                    <div class="status" id="client_public_key">-</div>
                </div>
                <div class="form-group">
                    <label>Clé privée du client:</label>
                    <div class="status" id="client_private_key">-</div>
                </div>
            </div>

            <div class="tab-pane" id="server-config">
                <h3>Configuration du Serveur</h3>
		<div class="form-group">
                    <label for="server_ip">IP du serveur (Wireguard)</label>
                    <input type="text" id="server_ip" placeholder="10.0.0.1">
                </div>
		<div class="form-group">
                    <label for="server_endpoint">IP du serveur (Physique)</label>
                    <input type="text" id="server_endpoint" placeholder="192.168.1.2">
                </div>
                <div class="form-group">
                    <label for="server_port">Port du Serveur</label>
                    <input type="number" id="server_port" placeholder="51820" min="1" max="65535">
                </div>
            </div>
        </div>
	<div class="form-group">
                <button onclick="createClientConfig()">Créer la configuration</button>
                <button onclick="sendPublicKey()">Envoyer la clé publique</button>
        </div>
    </div>

    <script>
        function showTab(tabId) {
            const panes = document.querySelectorAll('.tab-pane');
            panes.forEach(pane => pane.classList.remove('active'));
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab[onclick="showTab('${tabId}')"]`).classList.add('active');
        }

        function generateClientKeys() {
            fetch('/api/generate_keys')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('client_public_key').textContent = data.public_key;
                        document.getElementById('client_private_key').textContent = data.private_key;
                    } else {
                        alert('Erreur: ' + data.error);
                    }
                });
        }

        function createClientConfig() {
            const clientName = document.getElementById('client_name').value;
            const clientIp = document.getElementById('client_ip').value;
	    const clientEndpoint = document.getElementById('client_endpoint').value;
            const serverIp = document.getElementById('server_ip').value;
	    const serverEndpoint = document.getElementById('server_endpoint').value;
            const serverPort = document.getElementById('server_port').value;
	    const clientListenPort = document.getElementById('client_listen_port').value;
            const privateKey = document.getElementById('client_private_key').textContent;
            const publicKey = document.getElementById('client_public_key').textContent;

            if (!clientName || !clientIp || !serverIp || !serverEndpoint || !clientListenPort || !clientEndpoint || !serverPort || privateKey === '-' || publicKey === '-') {
                alert('Veuillez remplir tous les champs et générer des clés');
                return;
            }

            const formData = new FormData();
            formData.append('client_name', clientName);
            formData.append('client_ip', clientIp);
	    formData.append('client_endpoint', clientEndpoint);
            formData.append('server_ip', serverIp);
	    formData.append('server_endpoint', serverEndpoint);
            formData.append('server_port', serverPort);
            formData.append('client_listen_port', clientListenPort);
            formData.append('client_private_key', privateKey);
            formData.append('client_public_key', publicKey);

            fetch('/api/create_client_config', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Configuration client créée avec succès : ' + data.file);
                } else {
                    alert('Erreur: ' + data.error);
                }
            });
        }
	function sendPublicKey() {
    		const serverEndpoint = document.getElementById('server_endpoint').value;
    		if (!serverEndpoint) {
        		alert("Veuillez entrer l'adresse IP Physique du serveur");
        		return;
    		}

    		fetch('/api/send_public_key', {
        		method: 'POST',
        		headers: {
           		'Content-Type': 'application/json'
        		},
        		body: JSON.stringify({ dest_ip: serverEndpoint })
    		})
    		.then(response => response.json())
    		.then(data => {
        		if (data.success) {
            			alert('Clé publique envoyée au serveur');
        		} else {
            			alert('Erreur: ' + data.error);
        		}
    		});
	} 
   </script>
</body>
</html>
