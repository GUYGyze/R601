def debug_capture_all_udp(port=51820):
    """
    Capture tout trafic UDP vers/depuis le port WireGuard pour débogage.
    """
    with socket.socket(socket.AF_INET, socket.SOCK_RAW, socket.IPPROTO_UDP) as s:
        s.bind(('0.0.0.0', 0))
        print(f"[DEBUG] Surveillance de TOUT le trafic UDP sur port {port}")
        
        while True:
            try:
                packet, addr = s.recvfrom(65535)
                # Extraire les infos de l'en-tête IP
                ip_header = packet[:20]
                src_ip = socket.inet_ntoa(ip_header[12:16])
                dst_ip = socket.inet_ntoa(ip_header[16:20])
                
                # Extraire les ports de l'en-tête UDP
                udp_header = packet[20:28]
                src_port, dst_port = struct.unpack('!HH', udp_header[:4])
                
                if src_port == port or dst_port == port:
                    print(f"[DEBUG] UDP {src_ip}:{src_port} -> {dst_ip}:{dst_port}, taille={len(packet)-28}")
            except Exception as e:
                print(f"[DEBUG] Erreur capture: {e}")

debug_thread = threading.Thread(target=debug_capture_all_udp)
debug_thread.daemon = True
debug_thread.start()
